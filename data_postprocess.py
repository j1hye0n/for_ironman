import pandas as pd
import numpy as np
import pickle
import os

case_ind = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

fp = open('multiplication_index', 'rb')
multiplication_index = pickle.load(fp)
fp.close()

## ======================================================
# Convert solutions generated by RL to json files
## ======================================================
fp = open('RLMD/ac_mu_5_solution_100_1', 'rb')
rl = pickle.load(fp)
c_dict_solution = rl[1]
fp.close()

cases_index_list = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]

dsp_low = 0
dsp_up = 200

for graph_index in cases_index_list:
    
    if graph_index not in multiplication_index:
        continue

    current_mul = multiplication_index[graph_index]
    solution_len = len(current_mul)

    mapping_filename = 'info_case_' + str(case_ind[graph_index]) + '_node_number_mapping'
    
    inv_map = None
    if os.path.exists(mapping_filename):
        fp = open(mapping_filename, 'rb')
        mapping = pickle.load(fp)
        fp.close()
        inv_map = {v: k for k, v in mapping.items()}
        print(f"Case {case_ind[graph_index]}: Real DFG Mode (Mapping loaded)")
    else:
        print(f"Case {case_ind[graph_index]}: Synthetic DFG Mode")

    solution = []
    target = []

    for dsp_target in range(dsp_low, dsp_up):
        if (graph_index, dsp_target) in c_dict_solution:
            current_solution_set = c_dict_solution[graph_index, dsp_target]
            
            for j in range(len(current_solution_set)): # j th solution
                current_solution = []
                if len(current_solution_set[j]) == solution_len:
                    temp_sol_set = current_solution_set[j]
                else:
                    temp_sol_set = current_solution_set[j] + [1 for i in range(int(solution_len - len(current_solution_set[j])))]
                for k in range(solution_len):
                    if temp_sol_set[k] == 1:
                        if inv_map is not None:
                            val = inv_map[current_mul[k]] + 1
                        else:
                            val = current_mul[k] + 1
                        current_solution = current_solution + [val]
                solution = solution + [current_solution]
            target = target + [dsp_target for _ in range(len(current_solution_set))]
    if len(solution) > 0:
        df = pd.DataFrame([target, solution], index=["target_DSP", "solution"])
        if not os.path.exists('RL_solution/mu_2'):
            os.makedirs('RL_solution/mu_2')
            
        save_path = r'RL_solution/mu_2/case_' + str(case_ind[graph_index]) + '_RL_solution_mu_2.json'
        df.to_json(save_path)
        print(f"Saved: {save_path}")
    else:
        print(f"No solution found for graph_index {graph_index}")
